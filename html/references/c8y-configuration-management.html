<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Device Configuration Management using Cumulocity - thin-edge.io docs</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../././mdbook-admonish.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../SUMMARY.html"><strong aria-hidden="true">1.</strong> Summary</a></li><li class="chapter-item "><a href="../001_overview.html"><strong aria-hidden="true">2.</strong> Introduction</a></li><li class="chapter-item "><a href="../user_doc.html"><strong aria-hidden="true">3.</strong> User Documentation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../tutorials/tutorials.html"><strong aria-hidden="true">3.1.</strong> Tutorials</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../tutorials/getting-started.html"><strong aria-hidden="true">3.1.1.</strong> Getting started with thin-edge.io</a></li><li class="chapter-item "><a href="../tutorials/connect-c8y.html"><strong aria-hidden="true">3.1.2.</strong> Connect my device to Cumulocity IoT</a></li><li class="chapter-item "><a href="../tutorials/connect-azure.html"><strong aria-hidden="true">3.1.3.</strong> Connect my device to Azure IoT</a></li><li class="chapter-item "><a href="../tutorials/connect-aws.html"><strong aria-hidden="true">3.1.4.</strong> Connect my device to AWS IoT</a></li><li class="chapter-item "><a href="../tutorials/send-thin-edge-data.html"><strong aria-hidden="true">3.1.5.</strong> Send measurements</a></li><li class="chapter-item "><a href="../tutorials/raise-alarm.html"><strong aria-hidden="true">3.1.6.</strong> Raise alarms</a></li><li class="chapter-item "><a href="../tutorials/send-events.html"><strong aria-hidden="true">3.1.7.</strong> Send events</a></li><li class="chapter-item "><a href="../tutorials/device-monitoring.html"><strong aria-hidden="true">3.1.8.</strong> Monitor my device</a></li><li class="chapter-item "><a href="../tutorials/software-management.html"><strong aria-hidden="true">3.1.9.</strong> Manage my device software</a></li><li class="chapter-item "><a href="../tutorials/write-my-software-management-plugin.html"><strong aria-hidden="true">3.1.10.</strong> Write my software management plugin</a></li><li class="chapter-item "><a href="../tutorials/supported_operations.html"><strong aria-hidden="true">3.1.11.</strong> Supported Operations Management for Cumulocity IoT</a></li><li class="chapter-item "><a href="../tutorials/yocto-linux.html"><strong aria-hidden="true">3.1.12.</strong> Build Thin Edge for a Yocto Linux distribution</a></li><li class="chapter-item "><a href="../tutorials/child-device-config-management.html"><strong aria-hidden="true">3.1.13.</strong> Configuration management on child-devices</a></li></ol></li></ol></li><li class="chapter-item "><a href="../howto-guides/howto-guides.html"><strong aria-hidden="true">4.</strong> How-to Guides</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../howto-guides/002_installation.html"><strong aria-hidden="true">4.1.</strong> Installation</a></li><li class="chapter-item "><a href="../howto-guides/003_registration.html"><strong aria-hidden="true">4.2.</strong> How to create a test certificate</a></li><li class="chapter-item "><a href="../howto-guides/004_connect.html"><strong aria-hidden="true">4.3.</strong> How to connect a cloud end-point</a></li><li class="chapter-item "><a href="../howto-guides/005_pub_sub.html"><strong aria-hidden="true">4.4.</strong> How to send MQTT messages</a></li><li class="chapter-item "><a href="../howto-guides/007_test_connection.html"><strong aria-hidden="true">4.5.</strong> How to test the cloud connection?</a></li><li class="chapter-item "><a href="../howto-guides/008_config_local_mqtt_bind_address_and_port.html"><strong aria-hidden="true">4.6.</strong> How to configure the local mqtt bind address and port</a></li><li class="chapter-item "><a href="../howto-guides/009_trouble_shooting_monitoring.html"><strong aria-hidden="true">4.7.</strong> How to trouble shoot device monitoring</a></li><li class="chapter-item "><a href="../howto-guides/010_add_self_signed_trusted.html"><strong aria-hidden="true">4.8.</strong> How to add self-signed certificate root to trusted certificates list?</a></li><li class="chapter-item "><a href="../howto-guides/011_retrieve_jwt_token_from_cumulocity.html"><strong aria-hidden="true">4.9.</strong> How to retrieve JWT token from Cumulocity?</a></li><li class="chapter-item "><a href="../howto-guides/012_install_and_enable_software_management.html"><strong aria-hidden="true">4.10.</strong> How to install and enable software management?</a></li><li class="chapter-item "><a href="../howto-guides/013_connect_external_device.html"><strong aria-hidden="true">4.11.</strong> How to connect an external device?</a></li><li class="chapter-item "><a href="../howto-guides/014_thin_edge_logs.html"><strong aria-hidden="true">4.12.</strong> How to access the logs on the device?</a></li><li class="chapter-item "><a href="../howto-guides/015_installation_without_deb_support.html"><strong aria-hidden="true">4.13.</strong> How to install thin-edge.io on any Linux OS (no deb support)?</a></li><li class="chapter-item "><a href="../howto-guides/016_restart_device_operation.html"><strong aria-hidden="true">4.14.</strong> How to restart your thin-edge.io device</a></li><li class="chapter-item "><a href="../howto-guides/017_apama_software_management_plugin.html"><strong aria-hidden="true">4.15.</strong> How to use apama software management plugin</a></li><li class="chapter-item "><a href="../howto-guides/018_change_temp_path.html"><strong aria-hidden="true">4.16.</strong> How to change temp path</a></li><li class="chapter-item "><a href="../howto-guides/019_how_to_use_preferred_init_system.html"><strong aria-hidden="true">4.17.</strong> How to use thin-edge.io with your preferred init system</a></li><li class="chapter-item "><a href="../howto-guides/020_monitor_tedge_health.html"><strong aria-hidden="true">4.18.</strong> How to monitor health of tedge daemons</a></li><li class="chapter-item "><a href="../howto-guides/021_enable_tedge_watchdog_using_systemd.html"><strong aria-hidden="true">4.19.</strong> How to enable systemd watchdog monitoring for tedge services?</a></li><li class="chapter-item "><a href="../howto-guides/022_c8y_fragments.html"><strong aria-hidden="true">4.20.</strong> How to add custom fragments to Cumulocity</a></li><li class="chapter-item "><a href="../howto-guides/023_c8y_log_plugin.html"><strong aria-hidden="true">4.21.</strong> How to retrieve logs with the log plugin</a></li><li class="chapter-item "><a href="../howto-guides/024_smartrest_templates.html"><strong aria-hidden="true">4.22.</strong> How to use Cumulocity Custom SmartREST 2.0 Templates with thin-edge.io</a></li><li class="chapter-item "><a href="../howto-guides/025_config_management_plugin.html"><strong aria-hidden="true">4.23.</strong> How to manage configuration files with Cumulocity</a></li><li class="chapter-item "><a href="../howto-guides/026_how_to_install_thin_edge_manually.html"><strong aria-hidden="true">4.24.</strong> How to install thin-edge manually with OpenRC</a></li><li class="chapter-item "><a href="../howto-guides/child_device_config_management_agent.html"><strong aria-hidden="true">4.25.</strong> How to enable configuration management on child devices</a></li><li class="chapter-item "><a href="../howto-guides/027_remote_access_with_cumulocity.html"><strong aria-hidden="true">4.26.</strong> How to connect to your thin-edge.io device with Cumulocity remote access</a></li><li class="chapter-item "><a href="../howto-guides/028_c8y_service_monitoring.html"><strong aria-hidden="true">4.27.</strong> How to monitor a service from Cumulocity</a></li></ol></li><li class="chapter-item expanded "><a href="../dev_doc.html"><strong aria-hidden="true">5.</strong> Developer Documentation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../architecture/architecture.html"><strong aria-hidden="true">5.1.</strong> Architecture</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../architecture/domain-model.html"><strong aria-hidden="true">5.1.1.</strong> Domain Model</a></li><li class="chapter-item "><a href="../architecture/data-model.html"><strong aria-hidden="true">5.1.2.</strong> Data Model</a></li><li class="chapter-item "><a href="../architecture/thin-edge-json.html"><strong aria-hidden="true">5.1.3.</strong> Thin Edge Json</a></li><li class="chapter-item "><a href="../architecture/mapper.html"><strong aria-hidden="true">5.1.4.</strong> The Mapper</a></li><li class="chapter-item "><a href="../architecture/software-management.html"><strong aria-hidden="true">5.1.5.</strong> Software Management</a></li><li class="chapter-item "><a href="../architecture/faq.html"><strong aria-hidden="true">5.1.6.</strong> Architecture FAQ</a></li><li class="chapter-item "><a href="../supported-platforms.html"><strong aria-hidden="true">5.1.7.</strong> Platform support</a></li><li class="chapter-item "><a href="../references/init-system-config.html"><strong aria-hidden="true">5.1.8.</strong> Init System configuration</a></li></ol></li><li class="chapter-item "><a href="../tutorials/write-my-software-management-plugin.html"><strong aria-hidden="true">5.2.</strong> Write my own software management plugin</a></li><li class="chapter-item expanded "><a href="../references/c8y-configuration-management.html" class="active"><strong aria-hidden="true">5.3.</strong> Device Configuration Management using Cumulocity</a></li><li class="chapter-item "><a href="../api.html"><strong aria-hidden="true">5.4.</strong> APIs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../references/bridged-topics.html"><strong aria-hidden="true">5.4.1.</strong> The Bridged Topics</a></li><li class="chapter-item "><a href="../references/plugin-api.html"><strong aria-hidden="true">5.4.2.</strong> The Software Management Plugin API</a></li></ol></li><li class="chapter-item "><a href="../BUILDING.html"><strong aria-hidden="true">5.5.</strong> Building</a></li></ol></li><li class="chapter-item "><a href="../references/references.html"><strong aria-hidden="true">6.</strong> Command Line Reference</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../references/tedge.html"><strong aria-hidden="true">6.1.</strong> The tedge command</a></li><li class="chapter-item "><a href="../references/tedge-config.html"><strong aria-hidden="true">6.2.</strong> The tedge config command</a></li><li class="chapter-item "><a href="../references/tedge-cert.html"><strong aria-hidden="true">6.3.</strong> The tedge cert command</a></li><li class="chapter-item "><a href="../references/tedge-connect.html"><strong aria-hidden="true">6.4.</strong> The tedge connect command</a></li><li class="chapter-item "><a href="../references/tedge-disconnect.html"><strong aria-hidden="true">6.5.</strong> The tedge disconnect command</a></li><li class="chapter-item "><a href="../references/tedge-mqtt.html"><strong aria-hidden="true">6.6.</strong> The tedge mqtt command</a></li><li class="chapter-item "><a href="../references/thin-edge-config-files.html"><strong aria-hidden="true">6.7.</strong> Thin-edge.io configuration files</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">thin-edge.io docs</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="device-configuration-management-using-cumulocity"><a class="header" href="#device-configuration-management-using-cumulocity">Device Configuration Management using Cumulocity</a></h1>
<p>Thin-edge provides an operation plugin to
<a href="https://cumulocity.com/guides/users-guide/device-management/#to-retrieve-and-apply-a-configuration-snapshot-to-a-device-which-supports-multiple-configuration-types">manage device configurations using Cumulocity</a>.</p>
<ul>
<li>This management is bi-directional:
<ul>
<li>A device can be taken as reference, all the managed files being uploaded to the cloud
and stored there as a configuration snapshot.</li>
<li>A configuration snapshot can be pushed from the cloud to any devices of the same type,
i.e. supporting the same kind of configuration files.</li>
</ul>
</li>
<li>With this operation plugin, the device owner defines the list of files
(usually configuration files, but not necessarily),
that will be managed from the cloud tenant.</li>
<li>Notably, <strong>the plugin configuration itself is managed from the cloud</strong>,
meaning, the device owner can update from the cloud the list of files to be managed.</li>
<li>Cumulocity manages the configuration files accordingly to their type,
a name that is chosen by the device owner to categorise each configuration.
By default, the full path of a configuration file on the device is used as its type.</li>
<li>When files are downloaded from the cloud to the device,
<strong>these files are stored in a temporary directory first</strong>.
They are atomically moved to their target path, only after a fully successful download.
The aim is to avoid breaking the system with half downloaded files.</li>
<li>When a downloaded file is copied to its target, the unix user, group and mod are preserved.</li>
<li>Once a snapshot has been downloaded from Cumulocity to the device,
<strong>the plugin publishes a notification message on the local thin-edge MQTT bus</strong>.
The device software has to subscribe to these messages if any action is required,
say to check the content of file, to preprocess it or to restart a daemon.</li>
<li>The configuration plugin also manage configuration files for child-devices connected to the main thin-edge device.
From the cloud point of view, these child-devices are configured exactly using the same user interface,
with the ability to focus on a device, to upload the current configuration files,
to push configuration updates and to configure the list of configuration files.
Behind the scene, the behavior is a bit more complex,
the configuration plugin acting as a proxy between the cloud and the child-devices.
The configuration updates are downloaded from the cloud on the thin-edge device
then made available to the child-devices over HTTP,
MQTT being used to notify the availability of these configuration updates.
The child-device software has to subscribe to these messages, download the corresponding updates,
and notify the main thin-edge configuration plugin of the update status.
A similar combination of MQTT and HTTP is used to let the main device
request a child device for a configuration file actually in use.</li>
<li>In other words, the responsibilities of the plugin are:
<ul>
<li>to define the list of files under configuration management</li>
<li>to notify the cloud when this list is updated,</li>
<li>to upload these files to the cloud on demand,</li>
<li>to download the files pushed from the cloud,</li>
<li>to make sure that the target files are updated atomically after successful download,</li>
<li>to notify the device software when the configuration is updated,</li>
<li>to act as proxy for the child-devices that need configuration management,</li>
<li>to publish over a local HTTP server the configuration files and make them available to the child-devices,</li>
<li>to notify the child-devices when configuration updates are available,</li>
<li>to notify the child-devices when current configuration files are requested from the cloud,</li>
<li>to consume over a local HTTP server the configuration files pushed by the child-devices.</li>
</ul>
</li>
<li>By contrast, the plugin is not responsible for:
<ul>
<li>checking the uploaded files are well-formed,</li>
<li>restarting the configured processes,</li>
<li>installing the configuration files on the child-devices.</li>
</ul>
</li>
<li>For each child-device, a device-specific software component, referred to as a child-device agent, 
is required to listen for configuration related MQTT notification
and behave accordingly along the protocol defined by this configuration plugin.
<ul>
<li>Being specific to each type of child devices, this software has to be implemented specifically.</li>
<li>This software can be installed on the child device.</li>
<li>This software can also be installed on the main device,
when the target device cannot be altered
or connected to the main device over MQTT and HTTP.</li>
</ul>
</li>
<li>A user-specific component, installed on the device,
can implement more sophisticated configuration use-cases by:
<ul>
<li>listening for configuration updates on the local thin-edge MQTT bus,</li>
<li>restarting the appropriate processes when appropriate,</li>
<li>declaring intermediate files as the managed files,
to have the opportunity to check or update their content
before moving them to the actual targets.</li>
</ul>
</li>
</ul>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>Assuming the configuration plugin <code>c8y-configuration-plugin</code>
has been installed in <code>/usr/bin/c8y-configuration-plugin</code>,
two files must be added under <code>/etc/tedge/operations/c8y/</code>
to declare that this plugin supports two Cumulocity operations:
uploading and downloading configuration files
(which respective SmartRest2 codes are <code>526</code> and <code>524</code>).</p>
<p>These two files can be created using the <code>c8y-configuration-plugin --init</code> option:</p>
<pre><code class="language-shell">sudo c8y-configuration-plugin --init
</code></pre>
<pre><code class="language-shell">ls -l /etc/tedge/operations/c8y/c8y_UploadConfigFile
</code></pre>
<pre><code>-rw-r--r-- 1 tedge tedge 95 Mar 22 14:24 /etc/tedge/operations/c8y/c8y_UploadConfigFile
</code></pre>
<pre><code class="language-shell">ls -l /etc/tedge/operations/c8y/c8y_DownloadConfigFile
</code></pre>
<pre><code>-rw-r--r-- 1 tedge tedge 97 Mar 22 14:24 /etc/tedge/operations/c8y/c8y_DownloadConfigFile
</code></pre>
<p>The configuration plugin can also act as configuration proxy for child-devices.
For that to work for a child device named <code>$CHILD_DEVICE_ID</code>,
two files must be added under <code>/etc/tedge/operations/c8y/$CHILD_DEVICE_ID</code>
in order to declare the associated capabilities to Cumulocity.
These files are just empty files owned by the <code>tedge</code> user.</p>
<p>These two files are created by the plugin when the child-device agent uploads its supported configuration list to thin-edge.</p>
<pre><code class="language-shell">ls -l /etc/tedge/operations/c8y/child-1
</code></pre>
<pre><code>-rw-r--r-- 1 tedge tedge 97 Mar 22 14:24 /etc/tedge/operations/c8y/child-1/c8y_DownloadConfigFile
-rw-r--r-- 1 tedge tedge 95 Mar 22 14:24 /etc/tedge/operations/c8y/child-1/c8y_UploadConfigFile
</code></pre>
<pre><code class="language-shell">ls -l /etc/tedge/operations/c8y/child-2
</code></pre>
<pre><code>-rw-r--r-- 1 tedge tedge 97 Mar 22 14:24 /etc/tedge/operations/c8y/child-2/c8y_DownloadConfigFile
-rw-r--r-- 1 tedge tedge 95 Mar 22 14:24 /etc/tedge/operations/c8y/child-2/c8y_UploadConfigFile
</code></pre>
<p>The <code>c8y-configuration-plugin</code> has to be run as a daemon on the device, the latter being connected to Cumulocity.</p>
<p>On start of <code>tedge-mapper c8y</code> and on <code>/etc/tedge/operations/c8y</code> directory updates,
one can observe on the MQTT bus of the thin-edge device
the messages sent to Cumulocity to declare the capabilities of the main and child devices.
Here, the capabilities to upload and download configuration files
(possibly with other capabilities added independently):</p>
<pre><code class="language-shell">tedge mqtt sub 'c8y/s/us/#'
</code></pre>
<pre><code>[c8y/s/us] 114,c8y_Restart,c8y_SoftwareList,c8y_UploadConfigFile,c8y_DownloadConfigFile
[c8y/s/us/child-1] 114,c8y_UploadConfigFile,c8y_DownloadConfigFile
[c8y/s/us/child-2] 114,c8y_UploadConfigFile,c8y_DownloadConfigFile
</code></pre>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>The <code>c8y-configuration-plugin</code> configuration is stored by default under <code>/etc/tedge/c8y/c8y-configuration-plugin.toml</code></p>
<p>This <a href="https://toml.io/en/">TOML</a> file defines the list of files to be managed from the cloud tenant.
Each configuration file is defined by a record with:</p>
<ul>
<li>The full <code>path</code> to the file.</li>
<li>An optional configuration <code>type</code>. If not provided, the <code>path</code> is used as <code>type</code>.
This <code>type</code> is used to declare the configuration file to Cumulocity and then to trigger operations on that file.
All the configuration <code>type</code>s for the main device are declared to the cloud on start
and on change of the <code>c8y/c8y-configuration-plugin.toml</code> file.</li>
<li>Optional unix file ownership: <code>user</code>, <code>group</code> and octal <code>mode</code>.<br />
These are only used when a configuration file pushed from the cloud doesn't exist on the device.
When a configuration file is already present on the device, this plugin never changes file ownership,
ignoring these parameters.</li>
</ul>
<pre><code class="language-shell">cat /etc/tedge/c8y/c8y-configuration-plugin.toml
</code></pre>
<pre><code class="language-toml">files = [
  { path = '/etc/tedge/tedge.toml', type = 'tedge.toml' },
  { path = '/etc/tedge/mosquitto-conf/c8y-bridge.conf' },
  { path = '/etc/tedge/mosquitto-conf/tedge-mosquitto.conf' },
  { path = '/etc/mosquitto/mosquitto.conf', type = 'mosquitto', user = 'mosquitto', group = 'mosquitto', mode = 0o644 }
]
</code></pre>
<p>Along this <code>c8y-configuration-plugin</code> configuration for the main device,
the configuration plugin expects a configuration file per child device
that needs to be configured from the cloud.</p>
<ul>
<li>The configuration for a child-device <code>$CHILD_DEVICE_ID</code>
is stored by default under <code>/etc/tedge/c8y/$CHILD_DEVICE_ID/c8y-configuration-plugin.toml</code></li>
<li>These TOML files have the same schema as for the main device,
listing the configuration <code>files</code> and giving for each a <code>path</code> and possibly a <code>type</code>.</li>
<li>Note that the <code>path</code> doesn't need to be a file path.
It can be a key path in some registry of the child device or any name that makes sense for the child device.</li>
<li>As for the main device, the <code>type</code> is used to name the configuration file on the cloud.
All the configuration <code>type</code>s for a child devices are declared to the cloud on start
and on change of the <code>c8y/$CHILD_DEVICE_ID/c8y-configuration-plugin.toml</code> file.</li>
<li>The <code>user</code>, <code>group</code> and <code>mode</code> can be provided for a child-device configuration file,
notably when used by the child device,
but will not be used by the main device if provided.</li>
</ul>
<pre><code class="language-shell">ls /etc/tedge/c8y/*/c8y-configuration-plugin.toml
</code></pre>
<pre><code>/etc/tedge/c8y/child-1/c8y-configuration-plugin.toml 
/etc/tedge/c8y/child-2/c8y-configuration-plugin.toml
</code></pre>
<pre><code class="language-shell">cat /etc/tedge/c8y/child-1/c8y-configuration-plugin.toml
</code></pre>
<pre><code class="language-toml">files = [
  { path = '/var/camera.conf', type = 'camera' },
  { path = '/var/sounds.conf', type = 'sounds' },
]
</code></pre>
<pre><code class="language-shell">cat /etc/tedge/c8y/child-2/c8y-configuration-plugin.toml
</code></pre>
<pre><code class="language-toml">files = [
  { path = '/var/ai/model' },
]
</code></pre>
<p>On start and when one of these files is updated, the configuration plugin sends
one <a href="https://cumulocity.com/guides/10.14.0/reference/smartrest-two/#119"><code>119 SmartRest2 message</code></a> per device
to Cumulocity with the set of <code>type</code>s listed by the configuration
(adding implicitly the <code>c8y-configuration-plugin</code> themselves).
These messages can be observed over the MQTT bus of the thin-edge device.
In the case of the example, 3 messages are sent - one for the main device and 2 for the child devices:</p>
<pre><code class="language-shell">tedge mqtt sub 'c8y/s/us/#'
</code></pre>
<pre><code>[c8y/s/us] 119,c8y-configuration-plugin,tedge.toml,/etc/tedge/mosquitto-conf/c8y-bridge.conf,/etc/tedge/mosquitto-conf/tedge-mosquitto.conf,mosquitto
[c8y/s/us/child-1] 119,c8y-configuration-plugin,camera,sounds
[c8y/s/us/child-2] 119,c8y-configuration-plugin,/var/ai/model
</code></pre>
<p>Note that:</p>
<ul>
<li>The file <code>/etc/tedge/c8y/c8y-configuration-plugin.toml</code> itself doesn't need to be listed.
This is implied, so the list can <em>always</em> be configured from the cloud.
The <code>type</code> for this self configuration file is <code>c8y-configuration-plugin</code>.</li>
<li>If the file <code>/etc/tedge/c8y/c8y-configuration-plugin.toml</code>
is not found, empty, ill-formed or not-readable
then only <code>c8y-configuration-plugin.toml</code> is managed from the cloud.</li>
<li>Similarly, when there is a directory <code>/etc/tedge/c8y/$CHILD_DEVICE_ID/</code>
but the file <code>/etc/tedge/c8y/$CHILD_DEVICE_ID/c8y-configuration-plugin.toml</code>
is not found , empty, ill-formed or not-readable
then only <code>$CHILD_DEVICE_ID/c8y-configuration-plugin.toml</code> is managed from the cloud.</li>
<li>If the file <code>/etc/tedge/c8y/c8y-configuration-plugin.toml</code> is ill-formed
or cannot be read then an error is logged, but the operation proceed
as if the file were empty.
Similarly, for any file <code>/etc/tedge/c8y/$CHILD_DEVICE_ID/c8y-configuration-plugin.toml</code>.
So, the issue can be fixed from the cloud.</li>
</ul>
<p>The behavior of the <code>c8y-configuration-plugin</code> is also controlled
by the configuration of thin-edge:</p>
<ul>
<li><code>tedge config get mqtt.bind_address</code>: the address of the local MQTT bus.</li>
<li><code>tedge config get mqtt.port</code>: the TCP port of the local MQTT bus.</li>
<li><code>tedge config get tmp.path</code>: the directory where the files are updated
before being copied atomically to their targets.</li>
</ul>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<pre><code class="language-shell">c8y-configuration-plugin --help
</code></pre>
<pre><code>c8y-configuration-plugin 0.9.0

Thin-edge device configuration management for Cumulocity

USAGE:
    c8y-configuration-plugin [OPTIONS]

OPTIONS:
        --config-dir &lt;CONFIG_DIR&gt;      [default: /etc/tedge]
        --debug                        Turn-on the debug log level
    -h, --help                         Print help information
    -V, --version                      Print version information

    On start, `c8y-configuration-plugin` notifies the cloud tenant of the managed configuration files,
    listed in `CONFIG_DIR/c8y/c8y-configuration-plugin.toml`, sending this list with a `119` on `c8y/s/us`.
    `c8y-configuration-plugin` subscribes then to `c8y/s/ds` listening for configuration operation
    requests (messages `524` and `526`).
    notifying the Cumulocity tenant of their progress (messages `501`, `502` and `503`).
    
    The thin-edge `CONFIG_DIR` is used to find where:
    * to store the configuration file: `c8y/c8y-configuration-plugin.toml`
    * to store temporary files on download: `tedge config get tmp.path`,
    * to connect the MQTT bus: `tedge config get mqtt.port`.
</code></pre>
<h2 id="logging"><a class="header" href="#logging">Logging</a></h2>
<p>The <code>c8y-configuration-plugin</code> reports progress and errors on its <code>stderr</code>.</p>
<ul>
<li>All upload and download operation requests are logged, when received and when completed,
with one line per file.</li>
<li>All changes to the list of managed file is logged, one line per change.</li>
<li>All errors are reported with the operation context (upload or download? which file?).</li>
</ul>
<h2 id="notifications"><a class="header" href="#notifications">Notifications</a></h2>
<p>When a configuration file is successfully downloaded from the cloud,
the <code>c8y-configuration-plugin</code> service notifies this update over MQTT.</p>
<ul>
<li>The notification messages are published on the topic <code>tedge/configuration_change/{type}</code>,
where <code>{type}</code> is the type of the configuration file that have been updated,
for instance <code>tedge/configuration_change/tedge.toml</code></li>
<li>Each message provides the path to the freshly updated file as in <code>{ &quot;path&quot;: &quot;/etc/tedge/tedge.toml&quot; }</code>.</li>
</ul>
<p>Note that:</p>
<ul>
<li>If no specific type has been assigned to a configuration file, then the path to this file is used as its type.
Update notifications for that file are then published on the topic <code>tedge/configuration_change/{path}</code>,
for instance <code>tedge/configuration_change//etc/tedge/mosquitto-conf/c8y-bridge.conf</code>.</li>
<li>Since the type of configuration file is used as an MQTT topic name, the characters <code>#</code> and <code>+</code> cannot be used in a type name.
If such a character is used in a type name (or in the path of a configuration file without explicit type),
then the whole plugin configuration <code>/etc/tedge/c8y/c8y-configuration-plugin.toml</code> is considered ill-formed.</li>
</ul>
<h2 id="configuration-protocol-between-thin-edge-and-the-child-devices"><a class="header" href="#configuration-protocol-between-thin-edge-and-the-child-devices">Configuration protocol between thin-edge and the child-devices</a></h2>
<p>The configuration plugin <code>c8y-configuration-plugin</code> can act as a proxy between the cloud and a child-device.
However, for that to work, a client, referred to as child-device-agent, must be installed on the child device
to perform the actual configuration updates pushed by thin-edge on behalf of the cloud.
While the configuration plugin tells what need to be updated and when,
only the child device specific client can control where and how these updates can be applied.</p>
<ul>
<li>The responsibility of the configuration plugin is to
<ul>
<li>interact with the cloud, receiving the configuration update and configuration snapshot requests,</li>
<li>download/upload configuration files from/to the cloud to be exchanged with the child device</li>
<li>exchange configuration files with the child device via an HTTP-based file transfer service over the local network,</li>
<li>notify the child devices via MQTT when configuration files are to be updated or requested from the cloud,</li>
<li>listen to child devices' configuration operation status via MQTT messages and mirror those to the cloud.</li>
</ul>
</li>
<li>The child-device agent is an MQTT+HTTP client that
<ul>
<li>interact with the child-device system, accessing the actual configuration files</li>
<li>connect the main thin-edge device over the local MQTT bus,</li>
<li>listen over MQTT for configuration snapshot and update requests,</li>
<li>download and upload the configuration files on demand,</li>
<li>notify the progress of the configuration operations to the main device via MQTT.</li>
</ul>
</li>
</ul>
<p>For each kind of child device such an agent has to be implemented
and installed on the child-device hardware.
For a child device with closed software that cannot be altered,
one might have to install that agent with protocol adaptor on the main device.</p>
<p>Here is the protocol that has to be implemented by the child-device configuration client.
This protocol covers 4 interactions, the child devices:</p>
<ol>
<li>Connecting to thin-edge</li>
<li>Uploading its supported configuration list to thin-edge</li>
<li>Downloading configuration file updates from thin-edge</li>
<li>Uploading current configuration files to thin-edge</li>
<li>Notifying thin-edge of configuration operation status updates</li>
</ol>
<h3 id="the-child-device-connects-to-the-thin-edge-parent-device"><a class="header" href="#the-child-device-connects-to-the-thin-edge-parent-device">The child device connects to the thin-edge parent device</a></h3>
<p>From a TCP point of view, the child devices act as clients
and all the connections to thin-edge are established by the child devices.</p>
<ul>
<li>Thin-edge opens two ports for MQTT and HTTP over the local network.
These ports are controlled on the main device <code>tedge config</code>:
<ul>
<li><code>mqtt.external.bind_address</code></li>
<li><code>mqtt.external.port</code></li>
<li><code>http.external.port</code></li>
</ul>
</li>
<li>The child devices must know the main device IP address.
<ul>
<li>This is the address set for <code>mqtt.external.bind_address</code> on the main device.</li>
<li>For the very specific case, where the child-device agent runs on the main device,
this connection address can be the <code>localhost</code>.</li>
</ul>
</li>
<li>On start, the child-device agent for configuration management,
must connect over MQTT to thin-edge device.
<ul>
<li>It must use a session name that is unique on the thin-edge bus.
<code>&quot;$CHILD_DEVICE_ID/configuration&quot;</code> is the recommendation.</li>
<li>It must subscribe to <code>tedge/$CHILD_DEVICE_ID/commands/req/#</code> to receive requests.</li>
<li>It has to publish responses under <code>tedge/$CHILD_DEVICE_ID/commands/res/#</code>.</li>
</ul>
</li>
<li>On demand, the child-device agent has to send HTTP requests to thin-edge.
<ul>
<li>These requests are REST requests (GET/PUT/DELETE) to exchange files.</li>
<li>The urls are forged by thin-edge telling the child devices
where to get and put configuration files.</li>
</ul>
</li>
<li>Currently, all these connections are done without TLS support.
<ul>
<li>Hence, the main device must be configured so these MQTT and HTTP ports
are only open on a local trusted network.</li>
</ul>
</li>
</ul>
<h3 id="the-child-device-downloads-configuration-updates-on-notification"><a class="header" href="#the-child-device-downloads-configuration-updates-on-notification">The child device downloads configuration updates on notification</a></h3>
<p>When a configuration file for a child device
is received from the cloud by the <code>c8y-configuration-plugin</code> daemon,
the configuration plugin manages the transfer of this file to the child device
and notifies the cloud on the progress of this configuration update operation.</p>
<p>The following diagram captures the required interactions between all relevant parties:</p>
<pre class="mermaid">sequenceDiagram
    participant C8Y Cloud
    participant C8Y Config Plugin
    participant Tedge Agent
    participant Child Device Agent
    

        C8Y Cloud-&gt;&gt;C8Y Config Plugin: MQTT: c8y_DownloadConfigFile request with `child-id`, `type` and `c8y.url` for the updated config file
        C8Y Config Plugin-&gt;&gt;C8Y Cloud: Download the config-file from `c8y.url`
        C8Y Config Plugin-&gt;&gt;Tedge Agent: Move the downloaded config file to file-transfer repository and generate a `tedge.url` for it
        C8Y Config Plugin-&gt;&gt;Child Device Agent: MQTT: config_update request to `child-id` with `type` and `tedge.url`

        Child Device Agent -&gt;&gt; C8Y Config Plugin: MQTT: config_update response with operation status: &quot;executing&quot; 
        C8Y Config Plugin -&gt;&gt; C8Y Cloud: MQTT: Update c8y_DownloadConfigFile operation status to &quot;EXECUTING&quot;
        Child Device Agent-&gt;&gt;Tedge Agent: HTTP: Download the config file update from `tedge.url`
        Child Device Agent-&gt;&gt;Child Device Agent: Apply downloaded file as new config for `type`
        Child Device Agent -&gt;&gt; C8Y Config Plugin: MQTT: config_update response with operation status: &quot;successful&quot; 

        C8Y Config Plugin -&gt;&gt; C8Y Cloud: MQTT: Update c8y_DownloadConfigFile operation status to &quot;SUCCESSFUL&quot;
        C8Y Config Plugin -&gt;&gt; C8Y Config Plugin: Remove local copy of config file update from local filesystem
</pre>
<ol>
<li>On reception of a configuration update for a child device named <code>$CHILD_DEVICE_ID</code>
of a file <code>{ path = $PATH, type = $TYPE }</code> defined in <code>$CHILD_DEVICE_ID/c8y-configuration-plugin.toml</code> 
the <code>c8y-configuration-plugin</code> downloads the new configuration content to the temporary directory defined by <code>tedge config get tmp.path</code>,
and, on success, moves this content under the thin-edge file transfer HTTP root.
<ul>
<li>The file is moved to <code>$TEDGE_HTTP_ROOT/$CHILD_DEVICE_ID/config_update/$TYPE</code>
making this file available under <code>http://$TEDGE_HTTP/tedge/file-transfer/$CHILD_DEVICE_ID/config_update/$TYPE</code>.</li>
<li>Note that the <code>$TYPE</code> is by default the <code>$PATH</code> if not provided by the configuration.</li>
</ul>
</li>
<li>Once the updated configuration is available over the local HTTP file transfer service,
the <code>c8y-configuration-plugin</code> notifies the child device by publishing an MQTT message.
<ul>
<li>The topic is <code>tedge/$CHILD_DEVICE_ID/commands/req/config_update</code></li>
<li>The payload is a JSON record with 3 fields
<ul>
<li><code>&quot;url&quot;: &quot;http://$TEDGE_HTTP/tedge/file-transfer/$CHILD_DEVICE_ID/config_update/$TYPE&quot;</code></li>
<li><code>&quot;path&quot;: &quot;$PATH&quot;</code></li>
<li><code>&quot;type&quot;: &quot;$TYPE&quot;</code> (if no <code>type</code> has been specified, then this field is omitted)</li>
</ul>
</li>
</ul>
</li>
<li>On reception of a configuration update on the topic <code>tedge/$CHILD_DEVICE_ID/commands/req/config_update</code>,
The child-device agent for configuration management:
<ol>
<li><code>GET</code>s the content from the <code>url</code> specified by the notification message.</li>
<li>Uses the <code>path</code> and <code>type</code> information to apply the new configuration content.
Note that these pieces of information are provided by the child-device agent itself,
and make sense only in the specific context of the device operating system and software.</li>
</ol>
</li>
<li>While the configuration update is applied,
the child-device agent for configuration management,
notifies thin-edge over MQTT about the progress of this operation.
<ol>
<li>These messages are published on the topic
<code>tedge/$CHILD_DEVICE_ID/commands/res/config_update</code></li>
<li>There is three different payloads to notify the configuration operation started,
succeed or failed for some reason.</li>
<li>All these payloads are JSON records with 3 required fields:
<ul>
<li><code>&quot;status&quot;: &quot;$STATUS&quot;</code> where the status is either &quot;executing&quot;, &quot;successful&quot; or &quot;failed&quot;</li>
<li><code>&quot;path&quot;: &quot;$PATH&quot;</code></li>
<li><code>&quot;type&quot;: &quot;$TYPE&quot;</code></li>
<li><code>&quot;reason&quot;: &quot;$ERROR_MSG&quot;</code> telling the cause of the error if any.</li>
</ul>
</li>
<li>The child-device agent must send at least a success or an error message,
depending on the success of the <code>GET</code> and configuration operations.
It should also send an executing message before starting to process the request.</li>
</ol>
</li>
<li>On reception an operation status message,
the <code>c8y-configuration-plugin</code> notifies the cloud accordingly.
<ol>
<li>When a success or error message is finally received,
then the configuration plugin cleans up all the temporary resources,
notably removing the file under <code>$TEDGE_HTTP_ROOT/$CHILD_DEVICE_ID/config_update/$TYPE</code>.</li>
<li>If a notification message is received while none is expected,
i.e with a configuration file <code>type</code> that doesn't exist under <code>TEDGE_HTTP_ROOT/$CHILD_DEVICE_ID/config_update/</code>,
then this notification message is ignored.</li>
</ol>
</li>
</ol>
<h3 id="the-child-device-uploads-current-configuration-snapshot-on-request"><a class="header" href="#the-child-device-uploads-current-configuration-snapshot-on-request">The child device uploads current configuration snapshot on request</a></h3>
<p>The configuration files actually used by a child device can be requested from the cloud.
As for configuration updates, the <code>c8y-configuration-plugin</code> daemon drive these requests
using a combination of MQTT to notify the child device of the request
and of HTTP to let the child device <code>PUT</code> the requested file.</p>
<p>The following diagram captures the required interactions between all relevant parties:</p>
<pre class="mermaid">sequenceDiagram
    participant C8Y Cloud
    participant C8Y Config Plugin
    participant Tedge Agent
    participant Child Device Agent

        C8Y Cloud -&gt;&gt; C8Y Config Plugin: MQTT: c8y_UploadConfigFile request with `child-id` and `type`
        C8Y Config Plugin -&gt;&gt; C8Y Config Plugin: Generate file-transfer repository `tedge.url` for child device using `child-id` and `type`
        C8Y Config Plugin -&gt;&gt; Child Device Agent: MQTT: config_snapshot request to `child-id` with `type` and `tedge.url`

        Child Device Agent -&gt;&gt; C8Y Config Plugin: MQTT: config_snapshot response with operation status: &quot;executing&quot; 
        C8Y Config Plugin -&gt;&gt; C8Y Cloud: MQTT: Update c8y_UploadConfigFile operation status to &quot;EXECUTING&quot;
        Child Device Agent -&gt;&gt; Tedge Agent: HTTP: Upload config file content for `type` to `tedge.url`
        Child Device Agent -&gt;&gt; C8Y Config Plugin: MQTT: config_snapshot response with operation status: &quot;successful&quot; 

        C8Y Config Plugin -&gt;&gt; Tedge Agent: Retrieve the config file uploaded by the child device from file-transfer repository
        C8Y Config Plugin -&gt;&gt; C8Y Cloud: HTTP: Upload the config file to cloud
        C8Y Config Plugin -&gt;&gt; C8Y Cloud: MQTT: Update c8y_UploadConfigFile operation status to &quot;SUCCESSFUL&quot;
        C8Y Config Plugin -&gt;&gt; C8Y Config Plugin: Remove local copy of config file snapshot from local filesystem
</pre>
<ol>
<li>On reception of a configuration request for a child device named <code>$CHILD_DEVICE_ID</code>
for a file <code>{ path = $PATH, type = $TYPE }</code> defined in <code>$CHILD_DEVICE_ID/c8y-configuration-plugin.toml</code>
the <code>c8y-configuration-plugin</code> forwards this request to the child device by publishing an MQTT message
telling which configuration is expected and where to upload it.
<ul>
<li>The topic is <code>tedge/$CHILD_DEVICE_ID/commands/req/config_snapshot</code></li>
<li>The payload is a JSON record with 3 fields
<ul>
<li><code>&quot;url&quot;: &quot;http://$TEDGE_HTTP/tedge/file-transfer/$CHILD_DEVICE_ID/config_snapshot/$TYPE&quot;</code></li>
<li><code>&quot;path&quot;: &quot;$PATH&quot;</code></li>
<li><code>&quot;type&quot;: &quot;$TYPE&quot;</code> (if no <code>type</code> has been specified, then this field is omitted) </li>
</ul>
</li>
<li>The <code>url</code> conveys the fact the <code>c8y-configuration-plugin</code> expects that, on transfer success,
the file will be stored <code>$TEDGE_HTTP_ROOT/$CHILD_DEVICE_ID/config_snapshot/$TYPE</code>.
Note that when the <code>$TYPE</code> is not explicitly defined in <code>$CHILD_DEVICE_ID/c8y-configuration-plugin.toml</code>,
then the <code>$PATH</code> is used as the configuration type.</li>
</ul>
</li>
<li>On reception of a configuration request on the topic <code>tedge/$CHILD_DEVICE_ID/commands/req/config_snapshot</code>,
The child-device agent for configuration management:
<ol>
<li>Uses the <code>path</code> and <code>type</code> information to retrieve the requested configuration content.
Note that these pieces of information are provided by the child-device agent itself,
and make sense only in the specific context of the device operating system and software.</li>
<li><code>PUT</code>s the content to the <code>url</code> specified by the request message.</li>
</ol>
</li>
<li>The child-device agent for configuration management,
notifies thin-edge over MQTT about the progress of the configuration snapshot request.
<ol>
<li>These messages are published on the topic
<code>tedge/$CHILD_DEVICE_ID/commands/res/config_snapshot</code></li>
<li>There is three different payloads to notify the configuration operation started,
succeed or failed for some reason.</li>
<li>All these payloads are JSON records with 3 required fields:
<ul>
<li><code>&quot;status&quot;: &quot;$STATUS&quot;</code> where the status is either &quot;executing&quot;, &quot;successful&quot; or &quot;failed&quot;</li>
<li><code>&quot;path&quot;: &quot;$PATH&quot;</code></li>
<li><code>&quot;type&quot;: &quot;$TYPE&quot;</code></li>
<li><code>&quot;reason&quot;: &quot;$ERROR_MSG&quot;</code> telling the cause of the error if any.</li>
</ul>
</li>
<li>The child-device agent must send at least a success or an error message,
depending on the success of the <code>PUT</code> operation.
It should also send an executing message before starting to process the request.</li>
</ol>
</li>
<li>On reception of an operation status message,
the <code>c8y-configuration-plugin</code> notifies the cloud accordingly.
<ol>
<li>When a success message is received,
then the configuration plugin transfers to the cloud the content <code>PUT</code> by the child-device
under <code>$TEDGE_HTTP_ROOT/$CHILD_DEVICE_ID/config_snapshot/$TYPE</code> and
finally removes this file when acknowledged by the cloud.</li>
<li>If a notification message is received while none is expected for this type of configuration,
then this notification message is ignored.</li>
</ol>
</li>
</ol>
<h3 id="the-child-device-uploads-its-configuration-file-list-on-start-and-on-change"><a class="header" href="#the-child-device-uploads-its-configuration-file-list-on-start-and-on-change">The child device uploads its configuration file list on start and on change</a></h3>
<p>The configuration files for a child device <code>$CHILD_DEVICE_ID</code> are defined in
the file <code>$TEDGE_CONFIG_DIR/c8y/$CHILD_DEVICE_ID/c8y-configuration-plugin.toml</code> on the thin-edge device.
But, the content of this file must be provided by the child-device agent
by uploading a <code>c8y-configuration-plugin.toml</code> with <code>&quot;type&quot;: &quot;c8y-configuration-plugin&quot;</code> in its prescribed format.</p>
<p>The child-device must upload this file on its startup as well as when updated,
as if it received a config snapshot request for <code>c8y-configuration-plugin</code> type as follows:</p>
<ol>
<li>
<p>On start-up, the child-device uploads this file (as well as on update of this file list),
as if it received a config snapshot request for <code>c8y-configuration-plugin</code> type:</p>
<ol>
<li>Generate a <code>c8y-configuration-plugin.toml</code> with the supported config list in the prescribed format.</li>
<li>Uploads this file to <code>http://$TEDGE_HTTP/tedge/file-transfer/$CHILD_DEVICE_ID/c8y-configuration-plugin</code> with a <code>PUT</code> call.</li>
<li>On success of the upload, the child-device agent
notifies the <code>c8y-configuration-plugin</code> with an MQTT message published on the topic
<code>tedge/$CHILD_DEVICE_ID/commands/res/config_snapshot</code>
with the payload containing a JSON record with <code>&quot;type&quot;: &quot;c8y-configuration-plugin&quot;</code> but without the <code>status</code> field.</li>
<li>Note that there is no need to send executing notification messages here,
since this is a spontaneous operation and not triggered by an explicit config snapshot request.</li>
</ol>
</li>
<li>
<p>The plugin does the following on receipt of the response with <code>&quot;type&quot;: &quot;c8y-configuration-plugin&quot;</code>,
received for the upload on <code>tedge/$CHILD_DEVICE_ID/commands/res/config_snapshot</code> topic.</p>
<ol>
<li>Take a copy of the transferred file under <code>$TEDGE_HTTP_ROOT/$CHILD_DEVICE_ID/config_snapshot/c8y-configuration-plugin</code>
and puts this copy under <code>$TEDGE_CONFIG_DIR/c8y/$CHILD_DEVICE_ID/c8y-configuration-plugin.toml</code></li>
<li>Create two empty files <code>c8y_DownloadConfigFile</code> and <code>c8y_UploadConfigFile</code> under <code>/etc/tedge/operations/c8y/$CHILD_DEVICE_ID</code>
to inform the Cumulocity mapper that this child device supports configuration management.
On creation of these files, the mapper will automatically update child device twin with these supported operations.</li>
<li>Send a SmartREST 119 message with the list of configuration files listed in the file
(to which this file <code>$TEDGE_CONFIG_DIR/c8y/$CHILD_DEVICE_ID/c8y-configuration-plugin.toml</code>
is implicitly added with type <code>c8y-configuration-plugin</code>).</li>
</ol>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../tutorials/write-my-software-management-plugin.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../api.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../tutorials/write-my-software-management-plugin.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../api.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../mermaid.min.js"></script>
        <script type="text/javascript" src="../mermaid-init.js"></script>
    </body>
</html>
